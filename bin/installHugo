#!/usr/bin/env sh

tmp=
trap 'rm -fr -- "${tmp}"' EXIT INT
tmp="$(mktemp)"

hugo_version="0.88.1"

case "$(uname)" in
Linux) hugo_os='Linux-64bit' ;;
Darwin) hugo_os='macOS-64bit' ;;
*)
  printf 'This script only works on Linux and Mac os\n' >&2
  exit 1
  ;;
esac

hugo_install_path="$(cd "${0%/*}" && pwd)"

hugo_archive="hugo_extended_${hugo_version}_${hugo_os}.tar.gz"
hugo_url="https://github.com/gohugoio/hugo/releases/download/v${hugo_version}/${hugo_archive}"

if ! command -v hugo >/dev/null 2>&1; then
  # If hugo is not executable or not a file it must be downloaded and installed
  if ! { [ -x "${hugo_install_path}/hugo" ] && [ -f "${hugo_install_path}/hugo" ]; }; then
    if ! {
      wget "${hugo_url}" -O "${tmp}" &&
        cd "${hugo_install_path}" &&
        tar -xzf "${tmp}" hugo
    }; then
      printf 'Failed to download hugo\n' >&2
      exit 1
    fi
  fi

  local_bin="${HOME}/.local/bin"
  # Hugo needs be made available in local bin path
  mkdir -p -- "${local_bin}" &&
  ln -sf -- "${hugo_install_path}/hugo" "${local_bin}/" &&
  case ":$PATH:" in
    *:${local_bin}:*) ;;
    *)
      export PATH="${local_bin}:${PATH#:}"
      cat  >> "$HOME/.profile" <<EOF
[ -d "\${HOME}/.local/bin" ] && export PATH="\${HOME}/.local/bin:\${PATH#:}"
EOF
      ;;
  esac
else
  printf 'Hugo is already installed in this environment\n'
fi

hugo version
